<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Perfil - Participante</title>
  {% load static extra_filters %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    html,body{height:100%;}
    body{overflow:auto;}
    .layout{display:flex;align-items:stretch;}
    .left-side{flex:0 0 40%;background:#fff;display:flex;align-items:center;justify-content:center;position:sticky;top:0;height:100vh;}
    .right-side{flex:1;background:#26343a;color:#fff;display:flex;align-items:flex-start;justify-content:center;padding:40px 0;}
    .form-wrap{width:420px;}
    .form-wrap h2{color:#fff;font-weight:700;}
    .small-muted{color:rgba(255,255,255,.6);}
    .logo-img{max-width:360px;}
    .form-control{border-radius:8px;}
    .btn-primary{background:#0d6efd;border-color:#0d6efd;transition:box-shadow .2s,background-color .2s,border-color .2s,transform .2s;}
    .btn-primary:hover{background:#1677ff;border-color:#1677ff;box-shadow:0 0 12px rgba(13,110,253,.6);transform:translateY(-1px);}
    .btn-light{transition:box-shadow .2s,transform .2s;}
    .btn-light:hover{box-shadow:0 0 12px rgba(13,110,253,.45);transform:translateY(-1px);}
    .section-block{margin-top:32px;}
    .section-block:first-of-type{margin-top:16px;}
    .section-block h3{font-size:1rem;font-weight:600;margin:0 0 12px;display:flex;align-items:center;gap:8px;}
    .hint{color:rgba(255,255,255,.75);font-size:.75rem;margin-top:6px;}
    @media (max-width:900px){.layout{flex-direction:column;} .left-side,.right-side{width:100%;} .left-side{position:static;height:auto;} }
  </style>
  <script>
  function togglePassword(id,btn){const i=document.getElementById(id);const icon=btn.querySelector('i');if(i.type==='password'){i.type='text';icon.classList.replace('bi-eye-slash','bi-eye');}else{i.type='password';icon.classList.replace('bi-eye','bi-eye-slash');}}
  </script>
</head>
<body>
  {% include 'partials/participante_topbar.html' %}
  <div class="layout">
  <div class="left-side">
    {% if congreso and congreso.logo %}
      <img src="{{ congreso.logo.url }}" alt="{{ congreso.name }}" class="logo-img">
    {% else %}
      <img src="/static/images/logo_isc.png" alt="ISC" class="logo-img">
    {% endif %}
  </div>
  <div class="right-side">
    <div class="form-wrap">
      <h2>Perfil</h2>
      <p class="small-muted">Actualiza tu información de cuenta</p>
      {% if not approved %}
        <div class="warning-box">Tu membresía aún no está aprobada o fue rechazada. Información detallada de perfil restringida.</div>
      {% else %}
        {% if messages %}
          {% for m in messages %}
            <div class="alert {% if 'error' in m.tags %}alert-danger{% else %}alert-{{ m.tags }}{% endif %}">{{ m }}</div>
          {% endfor %}
        {% endif %}

        <div class="section-block">
          <h3><i class="bi bi-person-badge"></i> Datos Públicos</h3>
          <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_public">
          <div class="mb-3"><input class="form-control" name="first_name" value="{{ request.user.first_name }}" placeholder="Nombre(s)" required></div>
          <div class="mb-3"><input class="form-control" name="apellido_paterno" value="{{ extra_values_map|get_item:apellido_paterno_field_id|default:'' }}" placeholder="Apellido Paterno"></div>
          <div class="mb-3"><input class="form-control" name="apellido_materno" value="{{ extra_values_map|get_item:apellido_materno_field_id|default:'' }}" placeholder="Apellido Materno"></div>
          <div class="mb-3"><input class="form-control" value="{{ request.user.username }}" placeholder="Usuario" disabled></div>
          <div class="mb-3">
            {% if levels %}
              <select name="performance_level_id" class="form-control">
                <option value="">Selecciona tu nivel de desempeño</option>
                {% for lvl in levels %}<option value="{{ lvl.id }}" {% if membership.performance_level_id == lvl.id %}selected{% endif %}>{{ lvl.name }}</option>{% endfor %}
              </select>
            {% else %}
              <div class="hint">No hay niveles definidos para este congreso.</div>
            {% endif %}
          </div>
          {% if perfil_extra_fields %}
            <div class="mb-2"><strong>Información adicional</strong></div>
            {% for f in perfil_extra_fields %}
              {% if f.code != 'apellido_paterno' and f.code != 'apellido_materno' %}
                <div class="mb-3">
                  <label class="form-label" style="color:#fff;">{{ f.name }}{% if not f.required %} (opcional){% endif %}</label>
                  {% if f.field_type == 'text' %}
                    <input class="form-control" type="text" name="extra_{{ f.id }}" value="{{ extra_values_map|get_item:f.id|default:'' }}" {% if f.required %}required{% endif %}>
                  {% elif f.field_type == 'email' %}
                    <input class="form-control" type="email" name="extra_{{ f.id }}" value="{{ extra_values_map|get_item:f.id|default:'' }}" {% if f.required %}required{% endif %}>
                  {% elif f.field_type == 'number' %}
                    <input class="form-control" type="number" name="extra_{{ f.id }}" value="{{ extra_values_map|get_item:f.id|default:'' }}" {% if f.required %}required{% endif %}>
                  {% elif f.field_type == 'date' %}
                    <input class="form-control" type="date" name="extra_{{ f.id }}" value="{{ extra_values_map|get_item:f.id|default:'' }}" {% if f.required %}required{% endif %}>
                  {% elif f.field_type == 'boolean' %}
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="extra_{{ f.id }}" name="extra_{{ f.id }}" value="1" {% if extra_values_map|get_item:f.id == '1' %}checked{% endif %} {% if f.required %}required{% endif %}>
                      <label class="form-check-label" for="extra_{{ f.id }}">Sí</label>
                    </div>
                  {% elif f.field_type == 'select' %}
                    <select class="form-control" name="extra_{{ f.id }}" {% if f.required %}required{% endif %}>
                      <option value="">Selecciona una opción</option>
                      {% for opt in f.get_choices %}<option value="{{ opt }}" {% if extra_values_map|get_item:f.id == opt %}selected{% endif %}>{{ opt }}</option>{% endfor %}
                    </select>
                  {% else %}
                    <input class="form-control" type="text" name="extra_{{ f.id }}" value="{{ extra_values_map|get_item:f.id|default:'' }}" {% if f.required %}required{% endif %}>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
            <div class="mb-4"><button class="btn btn-light w-100" style="color:#0d6efd; border-radius:8px;">Guardar cambios</button></div>
          </form>
        </div>

        <div class="section-block">
          <h3><i class="bi bi-at"></i> Cambiar Usuario / Correo</h3>
          <form method="post">
            {% csrf_token %}<input type="hidden" name="action" value="change_user">
            <div class="mb-3"><input class="form-control" name="username" type="email" placeholder="Nuevo correo" required></div>
            <div class="mt-3"><button class="btn btn-light w-100" style="color:#0d6efd; border-radius:8px;">Actualizar usuario</button></div>
          </form>
        </div>

        <div class="section-block">
          <h3><i class="bi bi-shield-lock"></i> Cambiar Contraseña</h3>
          <form method="post">
            {% csrf_token %}<input type="hidden" name="action" value="change_password">
            <div class="mb-3 position-relative">
              <input id="current_password" class="form-control" name="current_password" type="password" placeholder="Contraseña actual" required>
              <button type="button" class="btn btn-primary" style="position:absolute;right:-2px;top:0;height:100%;border-radius:0 8px 8px 0;" onclick="togglePassword('current_password', this)"><i class="bi bi-eye-slash"></i></button>
            </div>
            <div class="mb-3 position-relative">
              <input id="new_password" class="form-control" name="new_password" type="password" placeholder="Nueva contraseña" required minlength="8" maxlength="16" pattern="(?=.{8,16}$)(?=.*[A-Z])(?=.*[a-z])(?=.*[\.\!%&\$\}]).+" title="8-16 caracteres, con al menos 1 mayúscula, 1 minúscula y 1 símbolo (.!%&$})">
              <button type="button" class="btn btn-primary" style="position:absolute;right:-2px;top:0;height:100%;border-radius:0 8px 8px 0;" onclick="togglePassword('new_password', this)"><i class="bi bi-eye-slash"></i></button>
            </div>
            <div class="hint">La contraseña debe tener 8-16 caracteres e incluir al menos 1 letra mayúscula, 1 letra minúscula y 1 símbolo especial (.!%&$}).</div>
            <div class="mb-3 position-relative mt-2">
              <input id="confirm_password" class="form-control" name="confirm_password" type="password" placeholder="Confirmar contraseña" required minlength="8" maxlength="16">
              <button type="button" class="btn btn-primary" style="position:absolute;right:-2px;top:0;height:100%;border-radius:0 8px 8px 0;" onclick="togglePassword('confirm_password', this)"><i class="bi bi-eye-slash"></i></button>
            </div>
            <div class="mt-2"><button class="btn btn-light w-100" style="color:#0d6efd; border-radius:8px;">Actualizar contraseña</button></div>
          </form>
        </div>
      {% endif %}
    </div>
  </div>
  </div>
  <script>
    function togglePassword(inputId, btn){const input=document.getElementById(inputId);const icon=btn.querySelector('i');if(input.type==='password'){input.type='text';icon.classList.remove('bi-eye-slash');icon.classList.add('bi-eye');}else{input.type='password';icon.classList.remove('bi-eye');icon.classList.add('bi-eye-slash');}}
  </script>
</body>
</html>
</html>
