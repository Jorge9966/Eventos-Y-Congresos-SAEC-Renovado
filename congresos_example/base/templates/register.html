<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Registrarme - Congresos o eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    /* Ocupamos toda la altura y hacemos que solo la columna derecha tenga scroll */
    html,body{height:100%;}
    body{display:flex; align-items:stretch; height:100vh; overflow:hidden;}
    .left-side{flex:0 0 40%; background:#fff; display:flex; align-items:center; justify-content:center; position:sticky; top:0; height:100vh;}
    .right-side{flex:1; background:#26343a; color:#fff; display:flex; align-items:flex-start; justify-content:center; padding:40px 0; height:100vh; overflow-y:auto;}
    .form-wrap{ width:420px; }
    .form-wrap h2{ color:#fff; font-weight:700; }
    .form-control{ border-radius:8px; }
  .btn-primary{ background:#0d6efd; border-color:#0d6efd; transition:box-shadow .2s, background-color .2s, border-color .2s, transform .2s; }
  .btn-primary:hover{ background:#1677ff; border-color:#1677ff; box-shadow:0 0 12px rgba(13,110,253,.6); transform:translateY(-1px); }
  .btn-light{ transition:box-shadow .2s, transform .2s; }
  .btn-light:hover{ box-shadow:0 0 12px rgba(13,110,253,.45); transform:translateY(-1px); }
    .tabs { display:flex; gap:24px; margin-bottom:18px; }
  .tabs a{ color:rgba(255,255,255,0.7); text-decoration:none; padding-bottom:6px; border-bottom:2px solid transparent; transition:color .2s, text-shadow .2s, border-color .2s; }
  .tabs a:hover{ color:#fff; text-shadow:0 0 10px rgba(255,255,255,.6); border-bottom-color:rgba(255,255,255,.45); }
    .tabs a.active{ color:#fff; border-bottom-color:rgba(255,255,255,0.2); }
    .small-muted{ color:rgba(255,255,255,0.6); }
    .logo-img{ max-width:360px; }
    .hint{ color:rgba(255,255,255,0.75); font-size:0.9rem; }
    .role-buttons { display:flex; gap:15px; margin:20px 0; }
  .role-btn { flex:1; border-radius:30px; padding:10px; border:2px solid #0d6efd; background:transparent; color:#0d6efd; font-weight:600; cursor:pointer; text-align:center; transition:box-shadow .2s, transform .2s, background-color .2s, color .2s, border-color .2s; }
  .role-btn:hover { box-shadow:0 0 14px rgba(13,110,253,.55); transform:translateY(-1px); }
  .role-btn.active { background:#0d6efd; color:#fff; }
  .role-btn.active:hover { box-shadow:0 0 16px rgba(13,110,253,.75); }
    /* En móviles, regresamos al scroll normal de la página */
    @media (max-width:900px){
      body{flex-direction:column; height:auto; overflow:auto;}
      .left-side,.right-side{width:100%; height:auto;}
      .left-side{position:static;}
      .right-side{overflow:visible;}
    }
  </style>
</head>
<body>
  {% load static %}
  <div class="left-side">
    {% if selected_congreso and selected_congreso.logo %}
      <img src="{{ selected_congreso.logo.url }}" alt="{{ selected_congreso.name }}" class="logo-img">
    {% else %}
      <img src="{% static 'base/img/SAEC.png' %}?v=2" alt="SAEC" class="logo-img">
    {% endif %}
  </div>
  <div class="right-side">
    <div class="form-wrap">
      <h2>Registrarme</h2>
      <p class="small-muted">Rellena los campos para crear una cuenta</p>

      <!-- Tabs originales -->
      <div class="tabs mt-4">
        <a href="{% url 'login' %}{% if selected_congreso %}?c={{ selected_congreso.id }}{% endif %}">Login</a>
        <a class="active" href="{% url 'register' %}{% if selected_congreso %}?c={{ selected_congreso.id }}{% endif %}">Registrarme</a>
      </div>

      <!-- Botones de tipo de usuario -->
      <div class="role-buttons">
        <div id="btn-participante" class="role-btn active" onclick="seleccionarTipo('participante')">Participante</div>
        <div id="btn-instructor" class="role-btn" onclick="seleccionarTipo('instructor')">Instructor</div>
      </div>

      {% if messages %}
        {% for m in messages %}
          <div class="alert {% if 'error' in m.tags %}alert-danger{% else %}alert-{{ m.tags }}{% endif %}">{{ m }}</div>
        {% endfor %}
      {% endif %}

      <form method="post" action="">
        {% csrf_token %}
        {% if selected_congreso %}
          <input type="hidden" name="c" value="{{ selected_congreso.id }}" />
        {% endif %}
        <input type="hidden" name="tipo_usuario" id="tipo_usuario" value="participante">

        <div class="mb-3"><input name="first_name" type="text" class="form-control" placeholder="Nombre(s)" required></div>
        <div class="mb-3"><input name="apellido_paterno" type="text" class="form-control" placeholder="Apellido Paterno" required></div>
        <div class="mb-3"><input name="apellido_materno" type="text" class="form-control" placeholder="Apellido Materno" required></div>
  <div class="mb-3"><input name="email" type="email" class="form-control" placeholder="Correo" required></div>
        <div class="mb-3 position-relative">
          <input id="password" name="password" type="password" class="form-control" placeholder="Contraseña" required minlength="8" maxlength="16" pattern="(?=.{8,16}$)(?=.*[A-Z])(?=.*[a-z])(?=.*[\.!%&\$\}]).+" title="8-16 caracteres, con al menos 1 mayúscula, 1 minúscula y 1 símbolo especial (.!%&$})">
          <button type="button" class="btn btn-primary" 
                  style="position:absolute; right:-2px; top:0; height:100%; border-radius:0 8px 8px 0;" 
                  onclick="togglePassword('password', this)">
            <i class="bi bi-eye-slash"></i>
          </button>
        </div>
        <div class="hint mb-3">La contraseña debe tener 8-16 caracteres e incluir al menos 1 letra mayúscula, 1 letra minúscula y 1 símbolo especial (.!%&$}).</div>

        <!-- Contraseña de acceso del congreso (reemplaza clave de instructor) -->
        <div class="mb-3" id="congreso_password_wrap">
          <div class="position-relative">
            <input id="congreso_password" name="congreso_password" type="password" class="form-control" placeholder="Contraseña de acceso del congreso">
            <button type="button" class="btn btn-primary" 
                    style="position:absolute; right:-2px; top:0; height:100%; border-radius:0 8px 8px 0;" 
                    onclick="togglePassword('congreso_password', this)">
              <i class="bi bi-eye-slash"></i>
            </button>
          </div>
        </div>

        <!-- Nivel de desempeño (solo participantes) -->
        <div class="mb-3" id="performance_level_wrap">
          {% if levels %}
            <select name="performance_level_id" class="form-control">
              <option value="">Selecciona tu nivel de desempeño</option>
              {% for lvl in levels %}
                <option value="{{ lvl.id }}">{{ lvl.name }}</option>
              {% endfor %}
            </select>
          {% else %}
            <div class="hint">No hay niveles definidos para este congreso.</div>
          {% endif %}
        </div>

        {% if extra_fields %}
        <div class="mb-2"><strong>Información adicional</strong></div>
        {% for f in extra_fields %}
          <div class="mb-3 extra-field" data-role-scope="{{ f.role_scope }}">
            <label class="form-label" style="color:#fff;">{{ f.name }}{% if not f.required %} (opcional){% endif %}</label>
            {% if f.field_type == 'text' %}
              <input class="form-control" type="text" name="extra_{{ f.id }}" {% if f.required %}required{% endif %}>
            {% elif f.field_type == 'email' %}
              <input class="form-control" type="email" name="extra_{{ f.id }}" {% if f.required %}required{% endif %}>
            {% elif f.field_type == 'number' %}
              <input class="form-control" type="number" name="extra_{{ f.id }}" {% if f.required %}required{% endif %}>
            {% elif f.field_type == 'date' %}
              <input class="form-control" type="date" name="extra_{{ f.id }}" {% if f.required %}required{% endif %}>
            {% elif f.field_type == 'boolean' %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="extra_{{ f.id }}" name="extra_{{ f.id }}" {% if f.required %}required{% endif %}>
                <label class="form-check-label" for="extra_{{ f.id }}">Sí</label>
              </div>
            {% elif f.field_type == 'select' %}
              <select class="form-control" name="extra_{{ f.id }}" {% if f.required %}required{% endif %}>
                <option value="">Selecciona una opción</option>
                {% for opt in f.get_choices %}
                  <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            {% else %}
              <input class="form-control" type="text" name="extra_{{ f.id }}" {% if f.required %}required{% endif %}>
            {% endif %}
          </div>
        {% endfor %}
        {% endif %}

        <div class="mb-4">
          <button class="btn btn-light w-100" style="color:#0d6efd; border-radius:8px;">Registrarme</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function seleccionarTipo(tipo) {
      document.getElementById("tipo_usuario").value = tipo;

      // Cambiar estilos de botones
      document.getElementById("btn-participante").classList.remove("active");
      document.getElementById("btn-instructor").classList.remove("active");
      document.getElementById("btn-" + tipo).classList.add("active");

      // Mostrar/ocultar campo de nivel de desempeño
      var lvlWrap = document.getElementById('performance_level_wrap');
      if (tipo === 'participante') {
        lvlWrap.classList.remove('d-none');
      } else {
        lvlWrap.classList.add('d-none');
      }

      // Mostrar/ocultar campos extra por rol y manejar atributo required
      var wrappers = document.querySelectorAll('.extra-field');
      wrappers.forEach(function(wrap){
        var scope = wrap.getAttribute('data-role-scope') || 'both';
        var show = (scope === 'both') || (scope === tipo);
        wrap.style.display = show ? '' : 'none';
        // actualizar required de inputs internos
        var inputs = wrap.querySelectorAll('input, select, textarea');
        inputs.forEach(function(inp){
          if (show) {
            if (inp.dataset._wasRequired === 'true') { inp.required = true; }
          } else {
            // recordar si era required para restaurar al volver a mostrar
            if (inp.required) inp.dataset._wasRequired = 'true';
            inp.required = false;
          }
        });
      });
    }

    // Estado inicial
    seleccionarTipo('participante');
  </script>
  <script>
    function togglePassword(inputId, btn) {
      const input = document.getElementById(inputId);
      const icon = btn.querySelector("i");

      if (input.type === "password") {
        input.type = "text";
        icon.classList.remove("bi-eye-slash");
        icon.classList.add("bi-eye");
      } else {
        input.type = "password";
        icon.classList.remove("bi-eye");
        icon.classList.add("bi-eye-slash");
      }
    }
  </script>
</body>
</html>